name: Helm Chart Testing

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2
        
      - name: Set up Helm
        uses: azure/setup-helm@v1
        
      - name: Install chart-testing tool
        run: |
          sudo apt-get install -y curl unzip
          curl -Lo chart-testing_3.4.0_linux_amd64.tar.gz https://github.com/helm/chart-testing/releases/download/v3.4.0/chart-testing_3.4.0_linux_amd64.tar.gz
          tar -xvf chart-testing_3.4.0_linux_amd64.tar.gz
          sudo mv ct /usr/local/bin/ct

      - name: Check for ct.yaml
        run: |
          if [ ! -f ct.yaml ]; then
            echo "ct.yaml not found!"
            exit 1
          fi

      - name: Run Helm chart tests
        run: |
          ct lint --config ct.yaml --all  # Reference ct.yaml
          ct install --config ct.yaml --all  # Reference ct.yaml
